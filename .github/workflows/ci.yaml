name: CI

on:
  push:
    branches: ["main"]
    tags: ["*"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            RAW="${GITHUB_REF#refs/tags/}"
            VERSION="${RAW#v}"
            IS_RELEASE="true"
          else
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
            LAST_TAG="${LAST_TAG#v}"
            VERSION="${LAST_TAG}-sha.${GITHUB_SHA::7}"
            IS_RELEASE="false"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "is_release=${IS_RELEASE}" >> "$GITHUB_OUTPUT"

      - name: Install devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Install project dependencies
        run: devbox install

      - name: Helm lint
        run: devbox run lint

      - name: Kind end-to-end test
        env:
          CLUSTER_NAME: ci-evict-rollout
        run: devbox run test

  publish-image:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push kubectl+jq image
        env:
          IMAGE_BASE: ghcr.io/${{ github.repository }}/kubectl-jq
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          IMAGE_BASE=$(echo "${IMAGE_BASE}" | tr '[:upper:]' '[:lower:]')
          docker buildx build \
            -f Dockerfile.kubectl-jq \
            --platform linux/amd64,linux/arm64 \
            -t "${IMAGE_BASE}:${VERSION}" \
            -t "${IMAGE_BASE}:latest" \
            --push .

  publish-chart:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v4.0.1

      - name: Update Chart metadata
        env:
          VERSION: ${{ needs.build.outputs.version }}
        run: |
          sed -i -E "s/^version:.*/version: ${VERSION}/" chart/evict-to-rollout/Chart.yaml
          sed -i -E "s/^appVersion:.*/appVersion: \"${VERSION}\"/" chart/evict-to-rollout/Chart.yaml

      - name: Login to GHCR for Helm
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            helm registry login ghcr.io \
              --username "${{ github.actor }}" \
              --password-stdin

      - name: Package and push Helm chart
        run: |
          mkdir -p dist
          helm package chart/evict-to-rollout --destination dist
          VERSION=$(awk '/^version:/ {print $2}' chart/evict-to-rollout/Chart.yaml | tr -d '"')
          REPO=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          helm push "dist/evict-to-rollout-${VERSION}.tgz" "oci://ghcr.io/${REPO}"

